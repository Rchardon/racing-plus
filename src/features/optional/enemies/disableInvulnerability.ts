import { EntityCollisionClass, EntityType } from "isaac-typescript-definitions";
import { config } from "../../../modConfigMenu";

// ModCallback.POST_NPC_UPDATE (0)
// EntityType.WIZOOB (219)
export function postNPCUpdateWizoob(npc: EntityNPC): void {
  setGhostCollisionClass(npc);
}

// ModCallback.POST_NPC_UPDATE (0)
// EntityType.THE_HAUNT (260)
export function postNPCUpdateHaunt(npc: EntityNPC): void {
  setGhostCollisionClass(npc);
}

// ModCallback.POST_NPC_UPDATE (0)
// EntityType.RED_GHOST (285)
export function postNPCUpdateRedGhost(npc: EntityNPC): void {
  setGhostCollisionClass(npc);
}

function setGhostCollisionClass(npc: EntityNPC) {
  if (!config.disableInvulnerability) {
    return;
  }

  // If this is a Haunt type, we only want to target Lil' Haunts.
  if (npc.Type === EntityType.THE_HAUNT && npc.Variant !== 10) {
    return;
  }

  // In vanilla, tears will pass through the Wizoobs & Red Ghosts during their "Appear" animation,
  // granting them invulnerability. This is because the ghost is set to `EntityCollisionClass.NONE`
  // when they spawn, and then set to `EntityCollisionClass.PLAYER_OBJECTS` during their first
  // reappearance.

  // Fix the invulnerability by manually setting the `EntityCollisionClass`. This cannot be done in
  // the `POST_NPC_INIT` callback because setting the `EntityCollisionClass` there has no effect.
  if (npc.FrameCount === 0) {
    npc.EntityCollisionClass = EntityCollisionClass.PLAYER_OBJECTS;
  }
}
